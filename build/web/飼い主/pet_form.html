<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>smore</title>
    <link rel="stylesheet" href="../styles/styles.css">
    <link rel="stylesheet" href="../styles/common.css">
</head>

<body>
    <!-- ログインしてないけどページを開いちゃった時の画面 -->
    <div class="center none" id="prompt" style="height: 600px;">
        <div class="center">
            <h1>ログインしてください</h1>
            <img width="100%" src="../images/Smore_illust_12.png" alt="">
            <p>ログインは<span id="login" onclick="location.href=['./login_form.html']">こちら</span></p>
        </div>
    </div>
    <!-- ----end---- -->
    <!-- 通常時の画面 -->
    <div id="big_container">
        <header class="page-header row">
            <div class="center col-3">
                <p onclick="location.href=['./飼い主my_page.html']">戻る</p>
            </div>
            <div class="col-6 center">
                <h1>ペット情報登録</h1>
            </div>
            <div class="col-3 center">
                <!-- このボタンは非表示 -->
                <button class="none" id="sign_out">ログアウト</button>
            </div>
        </header>
        <main>
            <div class="center">
                <div class="form_container" id="form_container">

                    <form id="myform" class="m_auto" style="width: 250px;">
                        <div class="space_32"></div>
                        <p>ペットの名前<span class="sub">必須</span></p>
                        <input type="text" placeholder=" ぽち" id="pet_name" class="input_width">
                        <div class="space_32"></div>
                        <p>生年月日<span class="sub">必須</span></p>
                        <div class="form-select-wrap">
                            <select class="birthday-year" id="select_year">
                                <option value="" selected>選択</option>
                            </select>
                            /
                            <select class="birthday-month" id="select_month">
                                <option value="" selected>選択</option>
                            </select>
                            /
                            <select class="birthday-day" id="select_day">
                                <option value="" selected>選択</option>
                            </select>
                        </div>
                        <div class="space_32"></div>
                        <p>性別<span class="sub">必須</span><br>
                        <div style="display: flex; justify-content: space-evenly;">
                            <lavel><input type="radio" name="sex" value="男の子"> 男の子</lavel>
                            <lavel><input type="radio" name="sex" value="女の子"> 女の子</lavel>
                        </div>
                        </p>
                        <div class="space_32"></div>
                        <p>犬種<span class="sub">必須</span>
                        <p style="font-size: 12px;">※不明な場合はミックスと記入してください</p>
                        <div class="type01">
                            <select name="genre" id="genre">
                                <option value="" disabled selected>五十音順で選択</option>
                                <option value="ミックス犬">ミックス犬</option>
                                <option value="あ行">あ行</option>
                                <option value="か行">か行</option>
                                <option value="さ行">さ行</option>
                                <option value="た行">た行</option>
                                <option value="な行">な行</option>
                                <option value="は行">は行</option>
                                <option value="ま行">ま行</option>
                                <option value="や行">や行</option>
                                <option value="ら行">ら行</option>
                                <option value="わ行">わ行</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                        </br>
                        <div class="type02">
                            <select name="food-name" id="food-name" style="width: 250px;" disabled>
                                <option value="" selected>犬種を選択</option>
                            </select>
                        </div>

                        <div class="space_32"></div>
                        <p>去勢・避妊<span class="sub">必須</span><br>
                        <div style="display: flex; justify-content: space-evenly;">
                            <label><input type="radio" name="去勢" value="未"> 未</label>
                            <label><input type="radio" name="去勢" value="済"> 済</label>
                        </div>
                        </p>
                        <div class="space_32"></div>
                        <p>体重<span class="sub">必須</span></p>
                        <div class="weight">
                            <select class="weight01" id="weight01">
                                <option value="" selected>選択</option>
                            </select>
                            <p style="padding-left: 5px; font-size: 36px;">.</p>
                            <select class="weight02" id="weight02">
                                <option value="0" selected>0</option>
                            </select>
                            kg
                        </div>
                        <div class="space_32"></div>
                        <p>毛色<span class="sub">必須</span></p>
                        <input type="text" id="color" placeholder=" ブラウン" class="input_width">
                        <div class="space_32"></div>
                        <p>耳<span class="sub">必須</span><br>
                        <div style="display: flex; justify-content: space-evenly;">
                            <label><input type="radio" name="耳" value="たれ耳"> たれ耳</label>
                            <label><input type="radio" name="耳" value="立ち耳"> 立ち耳</label>
                        </div>
                        </p>
                        <div class="space_32"></div>
                        <p>ごはん(品名・一日の給餌量)</p>
                        <input type="text" id="meal" placeholder=" ミシュワン,200" style="width: 234px; font-size: 16px;"> g
                        <div class="space_32"></div>
                        <p>かかりつけの病院</p>
                        <input type="text" id="doctor" placeholder=" 病院名" class="input_width">
                        <div class="space_32"></div>
                        <p>病歴・アレルギー</p>
                        <input type="text" id="allergy" placeholder=" 皮膚炎,チキンアレルギー" class="input_width">
                        <div class="space_32"></div>
                        <p>お薬 (現在服用中のお薬)</p>
                        <input type="text" id="medicine" placeholder=" マイフリーガード" class="input_width">
                        <div class="space_32"></div>
                        <p>サロン</p>
                        <input type="text" id="salon" placeholder=" サロン名" class="input_width">
                        <div class="space_32"></div>
                        <p>マイクロチップ番号 (15桁の数字)</p>
                        <input type="number" id="microchip_number" placeholder=" 392141234567891" class="input_width"
                            min="15" max="15">
                        <div class="space_32"></div>
                        <p>犬の登録をし、鑑札を受け取って<br>いますか？<span class="sub">必須</span><br>
                        <div style="display: flex; justify-content: space-evenly;">
                            <label><input type="radio" name="登録" value="はい"> はい</label>
                            <label><input type="radio" name="登録" value="いいえ"> いいえ</label>
                            <label><input type="radio" name="登録" value="不明"> 不明</label>
                        </div>
                        </p>
                        <div class="space_32"></div>
                        <p>狂犬病予防注射済票を受け取って<br>いますか？<span class="sub">必須</span><br>
                        <div style="display: flex; justify-content: space-evenly;">
                            <label><input type="radio" name="注射" value="はい"> はい</label>
                            <label><input type="radio" name="注射" value="いいえ"> いいえ</label>
                            <label><input type="radio" name="注射" value="不明"> 不明</label>
                        </div>
                        </p>
                        <div class="space_32"></div>
                        <p>写真1:ペット写真<span class="sub">必須</span></p>
                        <input type="file" accept='.jpeg, .png, .jpg' id="pet_img" required>
                        <p id="img01_uploading"></p>
                        <div class="space_32"></div>
                        <p>写真2:狂犬病予防注射済み票</p>
                        <input type="file" accept='.jpeg, .png, .jpg' id="狂犬病予防注射済み票">
                        <p id="img02_uploading"></p>
                        <div class="space_32"></div>
                        <p>写真3:混合ワクチン接種証明書</p>
                        <input type="file" accept='.jpeg, .png, .jpg' id="混合ワクチン接種証明書">
                        <p id="img03_uploading"></p>
                        <div class="space_48"></div>
                        <div class="text_center">
                            <input type="submit" value="登録" id="post_button">
                        </div>
                        <div class="space_48"></div>
                    </form>
                </div>
            </div>
        </main>
        <!-- footerは使ってない -->
        <footer class="page-footer"></footer>
    </div>
    <!-- ----end---- -->
    <script src="../dog_type.js"></script>
    <script src="../birthday.js"></script>
    <script src="../体重.js"></script>
    <script type="module">

        import { connect_firebase } from "../firebaseConfig.js"
        import { make_sign_out_display } from "../functions.js"
        import { getAuth, onAuthStateChanged } from " https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { collection, getFirestore, doc, setDoc } from " https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getStorage, ref, getDownloadURL, uploadBytes, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";

        // firebaseと接続
        const app = connect_firebase();
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);


        let user_id;
        let user_email;
        let newDoc;
        let pet_img_url = "";
        let 狂犬病予防注射済み票_url = "";
        let 混合ワクチン接種証明書url = "";

        // ログイン状態の確認 この関数はログイン状態が変わるたびに呼び出される
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                user_id = user.uid;
                user_email = user.email;
                console.log("状態:ログイン中");
                return make_docID(user_id)
            } else {
                console.log("状態:ログアウト");
                make_sign_out_display();
            }
        });

        // ドキュメントidを先に自動生成
        function make_docID(user_id) {
            const usersCollectionRef = collection(db, 'users', user_id, 'pets');
            newDoc = doc(usersCollectionRef).id
        }

        // input[type="file"]の中身は先に取得する
        let pet_img_file;
        let 狂犬病予防注射済み票_file;
        let 混合ワクチン接種証明書_file;

        const post_button = document.getElementById('post_button');
        const img01_uploading = document.getElementById('img01_uploading');
        const img02_uploading = document.getElementById('img02_uploading');
        const img03_uploading = document.getElementById('img03_uploading');

        const pet_img = document.getElementById("pet_img");
        pet_img.addEventListener('change', (e) => {
            console.log(e.target.files);

            pet_img_file = e.target.files[0];
            // pet_img
            const storageRef01 = ref(storage, "pets/" + newDoc + "/" + "pet_img");
            const uploadTask01 = uploadBytesResumable(storageRef01, pet_img_file);
            uploadTask01.on('state_changed',
                (snapshot) => {
                    post_button.classList.add("uploading");
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('Upload is ' + progress + '% done', "01の画像");
                    img01_uploading.textContent = `アップロード中 ${progress}%`;
                    switch (snapshot.state) {
                        case 'paused':
                            console.log('Upload is paused', "01の画像");
                            break;
                        case 'running':
                            console.log('Upload is running', "01の画像");
                            break;
                    }
                },
                (error) => {
                    // Handle unsuccessful uploads
                    console.log("Handle unsuccessful uploads", error);
                    alert('書き込みに失敗したか、権限がありません。');
                },
                () => {
                    getDownloadURL(uploadTask01.snapshot.ref).then((downloadURL) => {
                        console.log('File available at', downloadURL);
                        pet_img_url = downloadURL;
                        post_button.classList.remove('uploading')
                        img01_uploading.textContent = "";
                    });
                }
            );
        });
        const 狂犬病予防注射済み票 = document.getElementById("狂犬病予防注射済み票");
        狂犬病予防注射済み票.addEventListener('change', (e) => {
            console.log(e.target.files);
            狂犬病予防注射済み票_file = e.target.files[0];
            // 狂犬病予防注射済み票
            const storageRef02 = ref(storage, "pets/" + newDoc + "/" + "狂犬病予防注射済み票_img");
            const uploadTask02 = uploadBytesResumable(storageRef02, 狂犬病予防注射済み票_file);
            uploadTask02.on('state_changed',
                (snapshot) => {
                    post_button.classList.add("uploading");
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('Upload is ' + progress + '% done', "02の画像");
                    img02_uploading.textContent = `アップロード中 ${progress}%`;

                    switch (snapshot.state) {
                        case 'paused':
                            console.log('Upload is paused', "02の画像");
                            break;
                        case 'running':
                            console.log('Upload is running', "02の画像");
                            break;
                    }
                },
                (error) => {
                    // Handle unsuccessful uploads
                    console.log("Handle unsuccessful uploads", error);
                    alert('書き込みに失敗したか、権限がありません。');
                },
                () => {
                    getDownloadURL(uploadTask02.snapshot.ref).then((downloadURL) => {
                        console.log('File available at', downloadURL);
                        狂犬病予防注射済み票_url = downloadURL;
                        post_button.classList.remove('uploading')
                        img02_uploading.textContent = "";

                    });
                }
            );
        });

        const 混合ワクチン接種証明書 = document.getElementById("混合ワクチン接種証明書");
        混合ワクチン接種証明書.addEventListener('change', (e) => {
            console.log(e.target.files);

            混合ワクチン接種証明書_file = e.target.files[0];
            const storageRef03 = ref(storage, "pets/" + newDoc + "/" + "混合ワクチン接種証明書_img");
            const uploadTask03 = uploadBytesResumable(storageRef03, 混合ワクチン接種証明書_file);

            uploadTask03.on('state_changed',
                (snapshot) => {
                    post_button.classList.add("uploading");
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    console.log('Upload is ' + progress + '% done', "03の画像");
                    img03_uploading.textContent = `アップロード中 ${progress}%`;
                    switch (snapshot.state) {
                        case 'paused':
                            console.log('Upload is paused', "03の画像");
                            break;
                        case 'running':
                            console.log('Upload is running', "03の画像");
                            break;
                    }
                },
                (error) => {
                    // Handle unsuccessful uploads
                    console.log("Handle unsuccessful uploads", error);
                    alert('書き込みに失敗したか、権限がありません。');
                },
                () => {
                    getDownloadURL(uploadTask03.snapshot.ref).then((downloadURL) => {
                        console.log('File available at', downloadURL);
                        混合ワクチン接種証明書url = downloadURL;
                        post_button.classList.remove('uploading')
                        img03_uploading.textContent = "";

                    });
                }
            );
        });

        const select_year = document.getElementById('select_year')
        let select_year_value = select_year.value;
        select_year.addEventListener('change', () => {
            console.log(select_year.value)

            select_year_value = select_year.value

        })
        const select_month = document.getElementById('select_month')
        let select_month_value = select_month.value;
        select_month.addEventListener('change', () => {
            console.log(select_month.value)
            select_month_value = select_month.value

        })
        const select_day = document.getElementById('select_day')
        let select_day_value = select_day.value;
        select_day.addEventListener('change', () => {
            console.log(select_day.value)
            select_day_value = select_day.value

        })



        const weight01 = document.getElementById('weight01');
        let weight01_value = weight01.value;
        weight01.addEventListener('change', () => {
            console.log(weight01.value)
            weight01_value = weight01.value
        });
        const weight02 = document.getElementById('weight02');
        let weight02_value = weight02.value;
        weight02.addEventListener('change', () => {
            console.log(weight02.value)
            weight02_value = weight02.value
        });



        // 登録
        const myform = document.getElementById("myform")
        myform.addEventListener('submit', async (e) => {
            e.preventDefault();


            const pet_name = document.getElementById("pet_name").value;
            const birthday = `${select_year_value}年${select_month_value}月${select_day_value}日`;
            const sex = myform.elements.sex.value;
            const 去勢 = myform.去勢.value;
            const 耳 = myform.耳.value;
            const 登録 = myform.登録.value;
            const 注射 = myform.注射.value;
            const type = document.getElementById("food-name").value;
            const weight = `${weight01_value}.${weight02_value}`;
            const color = document.getElementById("color").value;
            const meal = document.getElementById("meal").value;
            const doctor = document.getElementById("doctor").value;
            const allergy = document.getElementById("allergy").value;
            const medicine = document.getElementById("medicine").value;
            const salon = document.getElementById("salon").value;
            const microchip_number = document.getElementById("microchip_number").value;
            // input テキスト、チェックボックスが空だった時のエラー処理
            console.log(weight01_value)
            console.log(weight02_value)
            const repu_arr01 = [pet_name, sex, 去勢, color, 耳, 登録, 注射];
            const messagebox01 = ["ペット名が入力されていません", "性別が選択されていません", "去勢、避妊が選択されていません", "毛色が入力されていません", "耳の種類が選択されていません","鑑札の受け取り項目が選択されていません", "狂犬病予防注射票の受け取り項目が選択されていません"]
            for (let i = 0; i < repu_arr01.length; i++) {
                if (repu_arr01[i] == "") {
                    alert(messagebox01[i])
                    return
                }
            }
            // input セレクトが空だった時のエラー処理
            const repu_arr02 = [select_year_value, select_month_value, select_day_value, weight01_value];
            const messagebox02 = ["生年月日が正しく入力されていません", "生年月日が正しく入力されていません", "生年月日が正しく入力されていません", "生年月日が正しく入力されていません"]
            for (let i = 0; i < repu_arr02.length; i++) {
                if (repu_arr02[i] == "") {
                    alert(messagebox02[i])
                    return
                }
            }

            try {


                let data = {
                    写真: pet_img_url,
                    名前: pet_name,
                    犬の登録をし鑑札を受け取っていますか: 登録,
                    狂犬病予防注射を受け注射済み票を受け取っていますか: 注射,
                    生年月日: birthday,
                    犬種: type,
                    去勢避妊: 去勢,
                    体重: weight,
                    毛色: color,
                    耳: 耳,
                    鼻動画: "movie",
                    性別: sex,
                    ごはん: meal,
                    かかりつけの病院: doctor,
                    病歴アレルギー: allergy,
                    お薬: medicine,
                    サロン: salon,
                    マイクロチップ番号: microchip_number,
                    狂犬病予防注射済み票: 狂犬病予防注射済み票_url,
                    混合ワクチン接種証明書: 混合ワクチン接種証明書url,
                    // スマホでこの処理がされない
                    ID: newDoc,
                    user_id: user_id,
                }
                console.log(data);
                await setDoc(doc(db, 'users', user_id, 'pets', newDoc), data) // memosのドキュメントにobjを追加
                window.location.href = './飼い主my_page.html';
            } catch (e) {
                console.error("Error adding document: ", e);
                alert('書き込みに失敗したか、権限がありません。');
            }
        });

    </script>
</body>

</html>