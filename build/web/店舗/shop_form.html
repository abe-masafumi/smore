<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>smore</title>
    <link rel="stylesheet" href="../styles/styles.css">
    <link rel="stylesheet" href="../styles/common.css">
    <style>
        html,
        body {
            overflow: hidden
        }
    </style>

    <script type="text/javascript" src="./qrcode.js"></script>
</head>

<body>
    <div class="center none" id="prompt" style="height: 800px;">
        <div class="center" style="width: 400px;">
          <h1>ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„</h1>
          <img width="100%" src="../images/Smore_illust_12.png" alt="">
          <p>ãƒ­ã‚°ã‚¤ãƒ³ã¯<span id="login" onclick="location.href=['./login_form.html']">ã“ã¡ã‚‰</span></p>
        </div>
      </div>
    <div id="big_container">
        <header class="page-header row">
            <div class="col-3 center">
                <button id="sign_out" class="">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
            <h1 class="col-6 center">åº—èˆ—ç™»éŒ²</h1>
            <div class="col-3"></div>
        </header>
        <main>
            <div class="center">
                <div id="form_container">
                    <div class="space_48"></div>
                    <form id="myform" class="m_auto">

                        <p>åº—èˆ—å</p>
                        <input type="text" placeholder="åº—èˆ—å" id="shopn_ame" required style="font-size: 16px;">
                        <div class="space_32"></div>
                        <p>ä½æ‰€(åº—èˆ—)</p>
                        <input type="text" placeholder="ä½æ‰€" id="address" required style="font-size: 16px;">
                        <div class="space_32"></div>
                        <p>é€£çµ¡å…ˆ(åº—èˆ—)</p>
                        <input type="tel" placeholder="é€£çµ¡å…ˆ" id="phone_no" required style="font-size: 16px;">
                        <div class="space_48"></div>
                        <div class="text_center">
                            <input type="submit" value="ç™»éŒ²" id="post_button">
                        </div>
                    </form>
                    <!-- éš ã—qrcode æ¶ˆã•ãªã„ã§ï¼ -->
                    <div id="qrcode" class="none"></div>
                </div>
            </div>
        </main>
        <footer class="page-footer"></footer>

    </div>
    <script type="module">

        import { connect_firebase } from "../firebaseConfig.js"
        import { make_sign_out_display } from "../functions.js"
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, doc, setDoc, Timestamp, getDoc } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-storage.js";
        // firebaseã¨æ¥ç¶š
        const app = connect_firebase();
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);

        let shop_id;
        let shop_email;

        async function get_data(shop_id) {
            const docRef = doc(db, "shops", shop_id);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                console.log("Document data:", docSnap.data());
                window.location.href = './åº—èˆ—ç®¡ç†ç”»é¢.html';
            } else {
                // doc.data() will be undefined in this case
                console.log("No such document!");
            }
        }

        // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã®ç¢ºèª ã“ã®é–¢æ•°ã¯ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãŒå¤‰ã‚ã‚‹ãŸã³ã«å‘¼ã³å‡ºã•ã‚Œã‚‹
        onAuthStateChanged(auth, async (user) => {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã‚‹ AND åº—èˆ—æƒ…å ±ãŒã™ã§ã«ç™»éŒ²ã•ã‚Œã¦ã„ãŸã‚‰ç”»é¢ã‚’åº—èˆ—ç®¡ç†ç”»é¢ã¸ç§»å‹•
            if (user) {
                console.log(user);
                shop_id = await user.uid;
                shop_email = await user.email;
                console.log(shop_id, "çŠ¶æ…‹:ãƒ­ã‚°ã‚¤ãƒ³ä¸­");
                return get_data(shop_id)
            } else {
                console.log("çŠ¶æ…‹:ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ");
                make_sign_out_display()
            }
        });

        // qcodeä½œæˆ     
        function saveCanvas() {
            const qrcodetag = document.getElementById("qrcode")
            var qrcode = new QRCode(qrcodetag, {
                // ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œç¢ºèªğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—ğŸ¤—
                text: `https://smore-832e4.web.app/é£¼ã„ä¸»/add_this_shop.html?shop_ID=${shop_id}`,
                width: 128,
                height: 128,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
            var canvas = qrcodetag.firstElementChild;
            let context = canvas.getContext('2d');
            // base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— ã€Œdata:image/png;base64,iVBORw0kï½ã€
            var base64 = canvas.toDataURL("png");
            return base64
        }

        document.getElementById("myform").addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = saveCanvas()
            const shopn_ame = document.getElementById("shopn_ame").value;
            const address = document.getElementById("address").value;
            const phone_no = document.getElementById("phone_no").value;
            // ã“ã“ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—ã—ãŸæ™‚ç‚¹ã§ã€ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªIDã‚’ä½œæˆã—ã€ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã€ç”»åƒåŒ–,ä¿å­˜,ãƒãƒ¼ã‚³ãƒ¼ãƒ‰URLã‚’firestoreã«ä¿å­˜
            try {
                // qrcodeã‚’firestrageã«ä¿å­˜
                const storageRef = ref(storage, "shops/" + shop_id + "/" + "images/" + "QRcode/");
                await uploadString(storageRef, file, 'data_url').then(async (snapshot) => {
                    console.log('Uploaded a blob or file!');
                    // ä¿å­˜ã—ãŸqrcodeã®urlã‚’å–å¾—ã—ã¦firestoreã«ä¸€ç·’ã«ä¿å­˜
                    await getDownloadURL(storageRef)
                        .then(async (url) => {
                            console.log("firesorageã®qrcodeURL", url);
                            // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã«ã™ã‚‹ 
                            await setDoc(doc(db, "shops", shop_id), {
                                address: address,
                                email: shop_email,
                                shop_id: shop_id,
                                shop_name: shopn_ame,
                                phone_nomber: phone_no,
                                web: "",
                                photo: "",
                                sns: "",
                                QRcode: url,
                                date: Timestamp.fromDate(new Date()),
                            });
                        })
                        .catch((error) => {
                            // Handle any errors
                            console.log("firestoreã«æ›¸ãè¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ", error);
                        });
                });
                window.location.href = './åº—èˆ—ç®¡ç†ç”»é¢.html';
            } catch (e) {
                console.error("Error adding document: ", e);
            }
        });
    </script>
</body>

</html>